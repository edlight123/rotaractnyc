rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // ───────────────────────────────────────
    // Helper functions
    // ───────────────────────────────────────
    function isAuthenticated() {
      return request.auth != null;
    }

    function role() {
      return request.auth.token.role;
    }

    function isMember() {
      return isAuthenticated() && role() in ['member', 'board', 'treasurer', 'president'];
    }

    function isBoard() {
      return isAuthenticated() && role() in ['board', 'treasurer', 'president'];
    }

    function isTreasurer() {
      return isAuthenticated() && role() in ['treasurer', 'president'];
    }

    function isPresident() {
      return isAuthenticated() && role() == 'president';
    }

    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }

    // ───────────────────────────────────────
    // Members
    // ───────────────────────────────────────
    match /members/{memberId} {
      // Members can read the full directory; pending users can read their own doc
      allow read: if isMember() || isOwner(memberId);

      // A signed-in user can create their own pending profile (auto-created on first Google Sign-In)
      allow create: if isOwner(memberId)
                    && request.resource.data.status == 'pending';

      // Members can update their own profile (but not role or status)
      allow update: if isOwner(memberId)
                    && !request.resource.data.diff(resource.data).affectedKeys()
                        .hasAny(['role', 'status']);

      // Board+ can update any member (role changes, approval, etc.)
      allow update: if isBoard();

      // Only president can delete members
      allow delete: if isPresident();
    }

    // ───────────────────────────────────────
    // Events (public + portal)
    // ───────────────────────────────────────
    match /events/{eventId} {
      // Public events readable by anyone; portal-only events by members
      allow read: if resource.data.visibility == 'public'
                  || (isMember() && resource.data.visibility in ['public', 'members', 'both']);

      // Board+ can manage events
      allow create, update, delete: if isBoard();
    }

    // ───────────────────────────────────────
    // RSVPs (top-level, doc ID = "{uid}_{eventId}")
    // ───────────────────────────────────────
    match /rsvps/{rsvpId} {
      // Members can read any RSVP (to see who else is going)
      allow read: if isMember();

      // Members can write their own RSVP (doc ID must start with their uid)
      allow create, update: if isAuthenticated()
                            && rsvpId.matches(request.auth.uid + '_.*');

      // Only owner or board can delete
      allow delete: if (isAuthenticated() && rsvpId.matches(request.auth.uid + '_.*'))
                    || isBoard();
    }

    // ───────────────────────────────────────
    // Articles (news / blog)
    // ───────────────────────────────────────
    match /articles/{articleId} {
      // Published articles readable by anyone (public site); members can read all
      allow read: if resource.data.status == 'published' || isMember();

      // Board+ can manage articles
      allow create, update, delete: if isBoard();
    }

    // ───────────────────────────────────────
    // Gallery
    // ───────────────────────────────────────
    match /gallery/{imageId} {
      // Gallery is publicly readable
      allow read: if true;

      // Board+ can manage gallery
      allow create, update, delete: if isBoard();
    }

    // ───────────────────────────────────────
    // Community Posts (portal feed)
    // ───────────────────────────────────────
    match /posts/{postId} {
      // Members can read all posts
      allow read: if isMember();

      // Members can create posts (must be authored by them)
      allow create: if isMember()
                    && request.resource.data.authorId == request.auth.uid;

      // Author can update their own post; any member can toggle likes
      allow update: if isMember() && (
        resource.data.authorId == request.auth.uid
        || request.resource.data.diff(resource.data).affectedKeys().hasOnly(['likes'])
      );

      // Board+ can update/delete any post
      allow update, delete: if isBoard();

      // Author can delete their own post
      allow delete: if isAuthenticated() && resource.data.authorId == request.auth.uid;

      // Comments subcollection
      match /comments/{commentId} {
        allow read: if isMember();
        allow create: if isMember();
        allow update, delete: if isAuthenticated()
                              && resource.data.authorId == request.auth.uid;
        allow update, delete: if isBoard();
      }
    }

    // ───────────────────────────────────────
    // Documents (meeting minutes, handbooks, etc.)
    // ───────────────────────────────────────
    match /documents/{documentId} {
      // Members can read documents
      allow read: if isMember();

      // Board+ can manage documents
      allow create, update, delete: if isBoard();
    }

    // ───────────────────────────────────────
    // Service Hours
    // ───────────────────────────────────────
    match /serviceHours/{entryId} {
      // Members can read their own entries; board can read all
      allow read: if (isAuthenticated() && resource.data.memberId == request.auth.uid)
                  || isBoard();

      // Members can create their own entries (must be pending)
      allow create: if isMember()
                    && request.resource.data.memberId == request.auth.uid
                    && request.resource.data.status == 'pending';

      // Members can update their own pending entries
      allow update: if isAuthenticated()
                    && resource.data.memberId == request.auth.uid
                    && resource.data.status == 'pending';

      // Board+ can approve/reject (update status) and delete
      allow update, delete: if isBoard();
    }

    // ───────────────────────────────────────
    // Dues Cycles
    // ───────────────────────────────────────
    match /duesCycles/{cycleId} {
      // All members can read dues cycles
      allow read: if isMember();

      // Only treasurer/president can manage cycles
      allow create, update, delete: if isTreasurer();
    }

    // ───────────────────────────────────────
    // Member Dues (per-member dues status)
    // ───────────────────────────────────────
    match /memberDues/{duesId} {
      // Members can read their own dues; treasurer+ can read all
      allow read: if (isAuthenticated() && resource.data.memberId == request.auth.uid)
                  || isTreasurer();

      // Treasurer+ can manage dues records
      allow create, update: if isTreasurer();
      allow delete: if isPresident();
    }

    // ───────────────────────────────────────
    // Transactions (finance)
    // ───────────────────────────────────────
    match /transactions/{transactionId} {
      // Only treasurer/president can read & manage transactions
      allow read, create, update, delete: if isTreasurer();
    }

    // ───────────────────────────────────────
    // Messages (member-to-member)
    // ───────────────────────────────────────
    match /messages/{messageId} {
      // Members can read messages sent to them or by them
      allow read: if isAuthenticated()
                  && (resource.data.recipientId == request.auth.uid
                      || resource.data.senderId == request.auth.uid);

      // Members can send messages
      allow create: if isMember()
                    && request.resource.data.senderId == request.auth.uid;

      // Recipient can mark as read
      allow update: if isAuthenticated()
                    && resource.data.recipientId == request.auth.uid
                    && request.resource.data.diff(resource.data).affectedKeys().hasOnly(['read']);

      // Sender or recipient can delete their copy
      allow delete: if isAuthenticated()
                    && (resource.data.senderId == request.auth.uid
                        || resource.data.recipientId == request.auth.uid);
    }

    // ───────────────────────────────────────
    // Site Settings (public)
    // ───────────────────────────────────────
    match /settings/{settingId} {
      // Anyone can read site settings (used on public site)
      allow read: if true;

      // Only president can update settings
      allow write: if isPresident();
    }

    // ───────────────────────────────────────
    // Deny everything else
    // ───────────────────────────────────────
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
